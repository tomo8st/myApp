<div class="login_header">    
    <mat-toolbar color="primary">
        <button mat-icon-button class="example-icon" 
          aria-label="Example icon-button with menu icon"
          routerLink="/login">
          <mat-icon>menu</mat-icon>
        </button>
        <span class="example-spacer"></span>
        <span>ToDo管理ツール</span>        
        <span class="example-spacer"></span>
        <span class="user-name">{{username}}</span>
    </mat-toolbar>
</div>

<div class="space_row"></div>

<mat-form-field class="input-field factory-input">
    <mat-label>日付</mat-label>
    <input matInput [matDatepicker]="picker" placeholder="日付" 
        autofocus #input1 class="ime-off" name="factory_input" 
        (dateChange)="onDateChange($event)"
        [(ngModel)]="targetDate">
    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
</mat-form-field>

<!-- <button type="button" name="button" (click)="onClickIpcTestBtn()">
    IPC呼び出し
</button> -->

<button type="button" name="button" (click)="onClickPlusButton()">
  ＋
</button>

<button type="button" name="button" (click)="onClickClearButton()">
  クリア
</button>

<!-- <button type="button" name="button" (click)="onClickSaveButton()">
  保存
</button> -->

<button type="button" name="button" (click)="onClickArrayDisplayButton()">
  配列表示
</button>

<button type="button" name="button" (click)="onClickDbSaveButton()">
  DB保存
</button>

<button type="button" name="button" (click)="onClickDbSearchButton()">
  DB検索
</button>

<button type="button" name="button" (click)="onClickTableDeleteAndRecreateButton()">
  テーブル削除
</button>

<button type="button" name="button" (click)="onClickCreateCategoryTableButton()">
  カテゴリテーブル作成
</button>

<button (click)="navigateToCategoryManagement()">カテゴリー管理</button>

<button mat-raised-button color="primary" (click)="onClickCsvImportButton()">
  CSVインポート
</button>

<button mat-raised-button color="primary" (click)="onClickCsvExportButton()">
  CSVエクスポート
</button>

<!-- 新しいボタンを追加 -->
<button mat-raised-button color="warn" (click)="onClickDeleteAllTodosButton()">
  全ToDo削除
</button>

<div class="table-area">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" >
      <ng-container matColumnDef="edit">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element; let i = index">
          <button mat-icon-button (click)="onClickEditButton(i)">
            <mat-icon>{{editableIndex === i ? 'done' : 'edit'}}</mat-icon>
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="moveRow">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element; let i = index">
          <button mat-icon-button (click)="onClickMoveRowUpButton(i)" [disabled]="i === 0">
            <mat-icon>arrow_upward</mat-icon>
          </button>
          <button mat-icon-button (click)="onClickMoveRowDownButton(i)" [disabled]="i === dataSource.length - 1">
            <mat-icon>arrow_downward</mat-icon>
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef
            class="table-header"> 
            id
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell">
            <ng-container *ngIf="editableIndex === i; else readOnly">
              <input matInput [(ngModel)]="element.id" class="input-cell" />                
            </ng-container>
            <ng-template #readOnly>
              <div class="cell-content">{{element.id}}</div>
            </ng-template>              
        </td>
      </ng-container>
      
      <ng-container matColumnDef="displayOrder">
        <th mat-header-cell *matHeaderCellDef
            class="table-header"> 
            表示順
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell">
            <ng-container *ngIf="editableIndex === i; else readOnly">
              <input matInput [(ngModel)]="element.displayOrder" class="input-cell" />                
            </ng-container>
            <ng-template #readOnly>
              <div class="cell-content">{{element.displayOrder}}</div>
            </ng-template>              
        </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef
              class="table-header"> 
              日付
          </th>
          <td mat-cell *matCellDef="let element; let i = index"
              class="table-cell">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.date" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.date}}</div>
              </ng-template>              
          </td>
      </ng-container>
  
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>カテゴリ</th>
        <td mat-cell *matCellDef="let element; let i = index">
          <ng-container *ngIf="editableIndex === i; else readOnlyCategory">
            <mat-select [(ngModel)]="element.category">
              <mat-option *ngFor="let category of categories" [value]="category.id">
                {{category.name}}
              </mat-option>
            </mat-select>
          </ng-container>
          <ng-template #readOnlyCategory>
            {{getCategoryName(element.category)}}
          </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="meeting">
        <th mat-header-cell *matHeaderCellDef
            class="table-header">
            MTG
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-mtg">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.meeting" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.meeting}}</div>
              </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="item">
        <th mat-header-cell *matHeaderCellDef
            class="table-header">
            ToDo項目
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.item" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.item}}</div>
              </ng-template>
        </td>
      </ng-container>
      
      <ng-container matColumnDef="begintime">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header qright">
            開始時刻 
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell qright mat-column-begintime">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.begintime" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.begintime}}</div>
              </ng-template>
        </td>
      </ng-container>
    
      <ng-container matColumnDef="endtime">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            終了時刻
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-endtime">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.endtime" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.endtime}}</div>
              </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="plantime">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            計画時間
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-plantime">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.plantime" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.plantime}}</div>
              </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="actualtime">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            実績時間 
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-actualtime">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.actualtime" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.actualtime}}</div>
              </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="diffefent">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            差異 
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-diffefent">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.diffefent" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.diffefent}}</div>
              </ng-template>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="planbegintime">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            計画時刻
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell mat-column-planbegintime">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.planbegintime" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.planbegintime}}</div>
              </ng-template>
        </td>
      </ng-container>

      <ng-container matColumnDef="etc">
        <th mat-header-cell *matHeaderCellDef 
            class="table-header">
            備考
        </th>
        <td mat-cell *matCellDef="let element; let i = index"
            class="table-cell">
              <ng-container *ngIf="editableIndex === i; else readOnly">
                <input matInput [(ngModel)]="element.etc" class="input-cell" />                
              </ng-container>
              <ng-template #readOnly>
                <div class="cell-content">{{element.etc}}</div>
              </ng-template>
        </td>
      </ng-container>

      <!-- 削除ボタン列を追加 -->
      <ng-container matColumnDef="delete">
        <th mat-header-cell *matHeaderCellDef> 削除 </th>
        <td mat-cell *matCellDef="let element; let i = index">
          <button mat-icon-button color="warn" (click)="onClickDeleteButton(i)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="my-row"></tr>
    </table>
</div>